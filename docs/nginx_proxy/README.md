# Nginx Proxy Setup

## Requirements

- Migration VM or machine to use as the proxy
- External DNS name for the proxy system with certificate (generated automatically if you use the certbot instructions below)
- Connectivity from the proxy machine to the customers system
  - In this scenario that means that the customer system must allow 443 access to their source instance from the proxy box
- Two-way connectivity between the proxy machine to the destination system
  - Destination must see proxy, proxy must see destination over 443
- A certificate for the source system
  - This can be CA signed or self-signed, but the choice changes the configuration of the proxy
- If a VPN is required, there may be additional considerations. Consult the [VPN helper documentation](https://gitlab.com/gitlab-org/professional-services-automation/tools/vpn_settings)

## Install certbot

 ```bash
 sudo apt-get install nginx certbot -y
 sudo apt-get install python3-certbot-nginx -y
 sudo certbot --nginx -d congregate.example.net
 ```

You will be prompted for an email "used for urgent renewal and security notices". Feel free to enter a dummy email if this is a temporary solution and you do not plan to maintain the certificate.

- You will need to allow port 80 and 443 open to the world for `certbot` to generate a cert from host VM
- If using a GitLab-managed VM, file an MR for the IaC pipelines. Do not modify via the console
  - Allow 80 and 443 for `0.0.0.0/0`
- Remove the `0.0.0.0/0` when you are done generating the certificates
  - You will still need to allow access from the appropriate destination systems (GitLab API fleet), the engineers, and admins

## Certificates

### Proxy External

If you followed the instructions above, `certbot` has already configured NGINX for your `/etc/nginx/sites-available/default` file to have the proper domain and certificate settings. Example:

```conf
  server_name congregate.example.net; # managed by Certbot. This is external DNS for the proxy system
  listen [::]:443 ssl ipv6only=on; # managed by Certbot
  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/congregate.example.net/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/nginx-test.gmgitlabglpersonal.net/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
```

**It is generally easiest to modify the default in place rather than attempt to setup a separate sites file**

If you would rather split those out into separate files, you can cut/paste the information into your `congregate.example.net.conf` file

### Customer System

#### Self-Signed

If the customer system is using a self-signed certificate, you will need let NGINX know what that certificate is so that it can trust it when forwarding to the upstream system.

In the simplest form, if the customers generated their certificate from openssl like:

```bash
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout selfsigned.key -out selfsigned.crt
```

Then we just need the CRT file. With that, we can configure NGINX like so:

```conf
proxy_pass                     https://secured-client.net;
proxy_ssl_trusted_certificate  /etc/nginx/selfsigned.crt;      # cert for the client (customer) self-signed
proxy_ssl_verify               on;
proxy_ssl_verify_depth         2;
proxy_ssl_session_reuse        on;
```

This should be sufficient for NGINX to trust the upstream customer system. In some instances, you may need to create a "full" self-signed cert

#### CA Trusted

If the customer is just using a standard CA certificate (such as the one generated by certbot for the proxy) there should not be anything that you need to configure for NGINX in regards to customer certificates.

#### Building a Full-Certificate

These are the old instructions, but I cannot figure out exactly why they were ever needed. My current theory is that they may be necessary if a customer runs an internal CA and issues a certificate that is "full-chain" but not available via the default ca-bundles.

<details><summary>Click to expand</summary>

- Retrieve self-signed certificate.
  - One may need to manually download the certificate from the SCM (BitBucket Server, GitHub) server.
  - If available to select download format, choose `Base-64 encoded X.509 (.CER)`.
- Manually create a `cert.pem` file in `/etc/nginx/` and append the **root**, **intermediate**, and **leaf** certificates.
- Compile `cert.pem` file as follows:

  ```text
  -----BEGIN CERTIFICATE-----
  root key
  -----END CERTIFICATE-----
  -----BEGIN CERTIFICATE-----
  intermediate key
  -----END CERTIFICATE-----
  -----BEGIN CERTIFICATE-----
  leaf key
  -----END CERTIFICATE-----
  ```

</details>

## NGINX Configuration

As stated above, it may be easier to simply use the default configuration that certbot generates for you in NGINX. You may need to pull the header information from the example conf file and add those as well, but I would test for their necessity before adding

```conf
proxy_pass_request_headers on;
proxy_set_header    X-Real-IP           $remote_addr;
proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
proxy_set_header    X-Forwarded-Proto   $scheme;
proxy_set_header    Host                example.github.url.com;
client_max_body_size       40960M;
```

If you wish to generate your own configuration file, remember to remove the proxy-specific settings from the default. Otherwise, they may conflict

### Custom conf Instructions

- Match the [`congregate.example.net.conf`](./congregate.example.net.conf) file with the assigned domain name.
- Store file at `/etc/nginx/sites-available/` as the default location.
- From the `/etc/nginx/sites-enabled/` folder symlink the file as follows:

  ```bash
  ln -s .../sites-available/congregate.example.net.conf .
  ```

## Transient Imports VM Firewall (GitLab PS specific)

- Configure the firewall for the transient imports VM ([console](https://console.cloud.google.com/compute/instances?project=transient-imports) and [project](https://gitlab.com/gitlab-com/gl-infra/transient-imports)) to allow the proxy pass-through.
- This usually means one has to additionally allow ports 80 and 443 for:
  - The [GitLab Web/API Fleet](https://docs.gitlab.com/ee/user/gitlab_com/#ip-range)
  - The user's local machine
  - The VM itself
    - Wait until the VM is created and add the host IP. Updating firewall rules should not change the host IP

**NOTE:** Any transient imports pipeline run will erase manual firewall changes to all machines in the space.

## Migration Note

When using the nginx proxy to run migrations, before running `congregate list`, configure the `congregate.conf` file's `src_hostname` to point to the source instance.

After listing (and staging), reconfigure the `congregate.conf` file's `src_hostname` to use the proxy's server name for the actual migration (`congregate migrate`).
