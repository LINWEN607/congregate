image: python:2.7.15-stretch

stages:
  - test
  - update-info
  - build
  - release

run tests:
  stage: test
  script:
    - pip install pipenv
    - pipenv install
    - pipenv run python -m unittest cli.config_test

update readme:
  stage: update-info
  script:
    - apt-get update
    - apt-get install -y jq
    - mkdir data
    - echo ${Dummy_config} | jq . > data/config.json
    - pip install pipenv
    - pipenv install
    - pipenv run python update-readme.py
  only:
    refs:
      - master
    changes:
      - congregate.py

archive project:
  stage: build
  script:
    - pip install pipenv
    - pipenv install
    - pipenv run dnd install
    - CI_COMMIT_TAG=${CI_COMMIT_TAG} ./build-tar.sh
  artifacts:
    paths:
      - congregate-${CI_COMMIT_TAG}.tar.gz
  cache:
    paths:
      - congregate-${CI_COMMIT_TAG}.tar.gz
  only:
    - tags

build docker image:
  stage: release
  script:
    - sudo docker login ${CI_REGISTRY} -u ${GITLAB_USER_LOGIN} -p ${ACCESS_TOKEN}
    - sudo docker build -f Dockerfile -t ${CI_REGISTRY_IMAGE}:latest -t ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG} --build-arg VERSION=${CI_COMMIT_TAG} .
    - sudo docker push ${CI_REGISTRY_IMAGE}:latest
    - sudo docker push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
    - sudo docker rm $(docker ps --all | awk '{print $1}')
  only:
    - tags
  tags:
    - docker-build


