stages:
  - build
  - test
  - release
  - deploy
include:
  - template: SAST.gitlab-ci.yml
  - template: Secret-Detection.gitlab-ci.yml
  - template: Code-Quality.gitlab-ci.yml

variables:
  DOCKER_VERSION: "19.03.1"
  TEST_IMAGE_NAME: "$CI_REGISTRY_IMAGE/test-3.8:latest"
  BB_SERVER_SEED_IMAGE_NAME: "$CI_REGISTRY_IMAGE/bitbucket-seed:latest"
  JENKINS_SEED_IMAGE_NAME: "$CI_REGISTRY_IMAGE/jenkins-seed:latest"
  SAST_DISABLE_DIND: "true"
  SAST_DEFAULT_ANALYZERS: "bandit"

default:
  image: "$TEST_IMAGE_NAME"
  tags:
    - gitlab-org

workflow:
  rules:
    # For merge requests, create a pipeline.
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    # For `master` branch, create a pipeline (this includes on schedules, pushes, merges, etc.).
    - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
    # For tags, create a pipeline.
    - if: "$CI_COMMIT_TAG"

.use-docker-in-docker:
  image: docker:${DOCKER_VERSION}
  services:
    - docker:${DOCKER_VERSION}-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  tags:
    # See https://gitlab.com/gitlab-com/www-gitlab-com/-/issues/7019 for tag descriptions
    - gitlab-org-docker

.docker-login:
  before_script:
    - docker login ${CI_REGISTRY} -u gitlab-ci-token -p $CI_BUILD_TOKEN

.gitlab-destination:
  services:
    - name: gitlab/gitlab-ee:nightly
      alias: gitlab_destination
      command:
        [
          "sh",
          "-c",
          "python3 -m http.server 443 --directory /var/log/gitlab/gitlab-rails/ & :; /assets/wrapper",
        ]

.e2e-cleanup:
  after_script:
    - curl -O http://gitlab_destination:443/api_json.log
    - curl -O http://gitlab_destination:443/importer.log
    - curl -O http://gitlab_destination:443/exceptions_json.log
    - poetry run aws ec2 terminate-instances --instance-ids $(cat instance_id)
  artifacts:
    when: always
    paths:
      - data/**/*.html
      - data/**/*diff*.json
      - data/**/*results.json
      - data/**/audit*.log
      - api_json.log
      - importer.log
      - exceptions_json.log

.jenkins-test:
  services:
    - name: "$JENKINS_SEED_IMAGE_NAME"
      alias: jenkins-test

code_quality:
  artifacts:
    paths: [gl-code-quality-report.json]

sast:
  artifacts:
    paths: [gl-sast-report.json]

secret_detection:
  variables:
    SECRET_DETECTION_HISTORIC_SCAN: "true"

version check:
  stage: build
  script:
    - dev/bin/version_check.sh
  rules:
    - if: "$CI_COMMIT_TAG"

build:
  extends:
    - .use-docker-in-docker
    - .docker-login
  stage: build
  script:
    - /bin/sh build_test_image.sh
  rules:
    - changes:
        - docker/test/*

build bitbucket seed image:
  extends:
    - .use-docker-in-docker
    - .docker-login
  stage: build
  script:
    - cp docker/bitbucket/Dockerfile ./
    - DOCKER_BUILDKIT=1 docker build -t $BB_SERVER_SEED_IMAGE_NAME . --build-arg BITBUCKET_LICENSE=$BITBUCKET_LICENSE --build-arg BITBUCKET_PASSWORD=$BITBUCKET_PASSWORD
    - docker push "$BB_SERVER_SEED_IMAGE_NAME"
  rules:
    - changes:
        - docker/bitbucket/Dockerfile
        - docker/bitbucket/entrypoint.py
        - docker/bitbucket/seed_data.sh

build jenkins seed image:
  extends:
    - .use-docker-in-docker
    - .docker-login
  stage: build
  script:
    - cd docker/jenkins
    - DOCKER_BUILDKIT=1 docker build -t $JENKINS_SEED_IMAGE_NAME .
    - docker push "$JENKINS_SEED_IMAGE_NAME"
  rules:
    - changes:
        - docker/jenkins/Dockerfile
        - docker/jenkins/entrypoint.sh
        - docker/jenkins/jenkins.py
        - docker/jenkins/setup_and_seed.py

.test-job:
  stage: test
  before_script:
    - pip install poetry
    # Disable parallel installer to avoid "Key Error" issues
    - poetry config experimental.new-installer false
    - poetry install
    - ./congregate.sh init
  retry: 2
  rules:
    - changes:
        - congregate/**/*
        - docker/test/*
        - congregate.sh
        - pyproject.toml
        - poetry.lock
        - spin_up_test_vm.sh
        - package.json
        - pylint*.sh
        - .pylintrc

test:pylint:
  extends: .test-job
  script:
    - ./pylint.sh
  artifacts:
    paths:
      - pylint.txt

test:pylint:syntax-errors:
  extends: .test-job
  script:
    - ./pylint-errors.sh
  artifacts:
    paths:
      - pylint.txt
    when: on_failure

test:unit:
  extends: .test-job
  script:
    - poetry run pytest -m 'unit_test' --cov-report html --cov-config=.coveragerc --cov=congregate congregate/tests/
  timeout: 5 minutes
  artifacts:
    paths:
      - htmlcov/*

test:end-to-end full:
  extends:
    - .test-job
    - .use-docker-in-docker
    - .gitlab-destination
    - .e2e-cleanup
  image: "${TEST_IMAGE_NAME}"
  tags:
    - congregate-auto-scale-runner
  script:
    - ./spin_up_test_vm.sh
    - export GITLAB_SRC=http://$(cat source_ip)
    - export GITLAB_SRC_REG_URL=$(cat source_ip):4567
    - export GITLAB_DEST=http://gitlab_destination
    - export GITLAB_DEST_REG_URL=gitlab_destination:4567
    - poetry run pytest -s -m e2e_gl_setup congregate/tests/
    - poetry run pytest -s -m e2e --cov-config=.coveragerc --cov=congregate congregate/tests/
  rules:
    - changes:
        - congregate/helpers/**/*
        - congregate/migration/gitlab/**/*
        - congregate/migration/migrate.py
  timeout: 25 minutes

test:end-to-end single group:
  extends:
    - .test-job
    - .use-docker-in-docker
    - .gitlab-destination
    - .e2e-cleanup
  image: "${TEST_IMAGE_NAME}"
  tags:
    - congregate-auto-scale-runner
  script:
    - ./spin_up_test_vm.sh
    - export GITLAB_SRC=http://$(cat source_ip)
    - export GITLAB_SRC_REG_URL=$(cat source_ip):4567
    - export GITLAB_DEST=http://gitlab_destination
    - export GITLAB_DEST_REG_URL=gitlab_destination:4567
    - poetry run pytest -s -m e2e_gl_setup_2 congregate/tests/
    - poetry run pytest -s -m e2e --cov-config=.coveragerc --cov=congregate congregate/tests/
  rules:
    - changes:
        - congregate/helpers/**/*
        - congregate/migration/gitlab/**/*
        - congregate/migration/migrate.py
  timeout: 12 minutes

test:GitHub Server end to end:
  extends:
    - .test-job
  image: "${TEST_IMAGE_NAME}"
  tags:
    - congregate-auto-scale-runner
  script:
    - curl -k $GH_TEST_INSTANCE_URL -v
  rules:
    - changes:
        - congregate/migration/github/**/*

test:Jenkins Integration Tests:
  extends:
    - .jenkins-test
    - .test-job
  image: "${TEST_IMAGE_NAME}"
  tags:
    - congregate-auto-scale-runner
  script:
    - while [[ "$(curl -s -o /dev/null -w ''%{http_code}'' http://jenkins-test:8080/job/test-job/config.xml --user $JENKINS_USER:$JENKINS_PASSWORD)" != "200" ]]; do echo "Waiting for Jenkins to start"; sleep 5; done
    - curl http://jenkins-test:8080/job/test-job/config.xml --user $JENKINS_USER:$JENKINS_PASSWORD
    - echo "Jenkins is up and running, starting pytest"
    - poetry run pytest -s -m "jenkins_it" congregate/tests/
  rules:
    - changes:
        - congregate/migration/jenkins/**/*
  timeout: 10 minutes

debian rolling release:
  extends:
    - .use-docker-in-docker
    - .docker-login
  stage: release
  rules:
    - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
  variables:
    RELEASE_IMAGE_NAME: "$CI_REGISTRY_IMAGE:rolling-debian"
  script:
    - cp docker/release/debian.Dockerfile ./Dockerfile
    - DOCKER_BUILDKIT=1 docker build --tag "$RELEASE_IMAGE_NAME" .
    - docker push "$RELEASE_IMAGE_NAME"

debian-release-tag:
  extends:
    - .use-docker-in-docker
    - .docker-login
  rules:
    - if: "$CI_COMMIT_TAG"
  stage: release
  variables:
    RELEASE_IMAGE_NAME: "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME-debian"
    LATEST: "$CI_REGISTRY_IMAGE:latest-debian"
  script:
    - cp docker/release/debian.Dockerfile ./Dockerfile
    - DOCKER_BUILDKIT=1 docker build --tag "$RELEASE_IMAGE_NAME" .
    - docker image tag $RELEASE_IMAGE_NAME $LATEST
    - docker push "$RELEASE_IMAGE_NAME"
    - docker push "$LATEST"

centos rolling release:
  extends:
    - .use-docker-in-docker
    - .docker-login
  stage: release
  rules:
    - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
  variables:
    RELEASE_IMAGE_NAME: "$CI_REGISTRY_IMAGE:rolling-centos"
  script:
    - cp docker/release/centos.Dockerfile ./Dockerfile
    - DOCKER_BUILDKIT=1 docker build --tag "$RELEASE_IMAGE_NAME" .
    - docker push "$RELEASE_IMAGE_NAME"

centos-release-tag:
  extends:
    - .use-docker-in-docker
    - .docker-login
  rules:
    - if: "$CI_COMMIT_TAG"
  stage: release
  variables:
    RELEASE_IMAGE_NAME: "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME-centos"
    LATEST: "$CI_REGISTRY_IMAGE:latest-centos"
  script:
    - cp docker/release/centos.Dockerfile ./Dockerfile
    - DOCKER_BUILDKIT=1 docker build --tag "$RELEASE_IMAGE_NAME" .
    - docker image tag $RELEASE_IMAGE_NAME $LATEST
    - docker push "$RELEASE_IMAGE_NAME"
    - docker push "$LATEST"

runbook update:
  stage: test
  script:
    - echo "This is a placeholder job ran only when runbooks are changed"
    - echo "Storing any changed runbook to artifacts that will expire in 1 week."
    # To the ps-migration project
    - python runbookscript.py 11750578
    # To the Migration Template
    - python runbookscript.py 21146917
  rules:
    - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
    - changes:
        - runbooks/*
  artifacts:
    paths:
      - runbooks/*
    expire_in: 1 week

mvc:
  stage: test
  script:
    - echo "Placeholder job to trigger a min. pipeline for non-code related changes"
  rules:
    - if: "$CI_MERGE_REQUEST_IID || $CI_COMMIT_BRANCH"
      changes:
        - "**/*.md"
        - README.md
        - docker/release/*

pages:
  stage: deploy
  rules:
    - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
    - changes:
        - runbooks/*
        - congregate/docs/**/*
        - ./**/*.md
  # dependencies:
  #   - code_quality
  script:
    - mkdir -p data
    - poetry config experimental.new-installer false
    - poetry install
    # - mv gl-code-quality-report.json congregate/docs/source/_static/
    - poetry run sphinx-apidoc -f -o congregate/docs/source/ ./
    - cd congregate/docs
    - make html
    - mv build/html ../../public
  retry: 2
  artifacts:
    paths:
      - public
