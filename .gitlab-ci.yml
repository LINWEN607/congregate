image: python:2.7.15-stretch

include:
  template: SAST.gitlab-ci.yml

sast:
  variables:
    CI_DEBUG_TRACE: "true"

stages:
  - test
  - update-info
  - build
  - release

.install_test_dependencies: &install_test_dependencies
  before_script:
    - apt-get update
    - apt-get install -y jq
    - mkdir data
    - echo ${Dummy_config} | jq . > data/config.json
    - pip install pipenv
    - pipenv install

run tests:
  stage: test
  <<: *install_test_dependencies
  script:
    - pipenv run python -m unittest discover congregate/

update readme:
  stage: update-info
  <<: *install_test_dependencies
  script:
    - pipenv run python congregate/update-readme.py
  only:
    refs:
      - master
    changes:
      - congregate/congregate.py

archive project:
  stage: build
  script:
    - pip install pipenv
    - pipenv install
    # - pipenv run dnd install currently broken, will need to copy js-packages to docker-container
    - CI_COMMIT_TAG=${CI_COMMIT_TAG} ./build-tar.sh
  artifacts:
    paths:
      - congregate-${CI_COMMIT_TAG}.tar.gz
  cache:
    paths:
      - congregate-${CI_COMMIT_TAG}.tar.gz
  only:
    - tags

build docker image:
  image: docker:latest
  services:
    - docker:dind
  stage: release
  script:
    - docker login ${CI_REGISTRY} -u ${GITLAB_USER_LOGIN} -p ${ACCESS_TOKEN}
    - docker build -f Dockerfile -t ${CI_REGISTRY_IMAGE}:latest -t ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG} --build-arg VERSION=${CI_COMMIT_TAG} .
    - docker push ${CI_REGISTRY_IMAGE}:latest
    - docker push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
  only:
    - tags
