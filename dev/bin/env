#!/usr/bin/env bash

function get_latest_master_tag() { git ls-remote git@gitlab.com:gitlab-com/customer-success/tools/congregate.git | grep refs/heads/master | cut -f 1; }

function get_congregate_pids() { ps aux | grep "congregate" | awk '{print $2}' | grep -v grep; }

alias penv='poetry install'
alias ui='npm install'
alias sh='poetry shell'
alias upd='poetry run python congregate/update-readme.py'
alias pt='poetry run pytest \
            -m "unit_test" \
            --cov-report term-missing \
            --cov-report html \
            --cov-config=.coveragerc \
            --cov=congregate congregate/tests/'
alias pt_e2e='poetry run pytest -s -m e2e congregate/tests/'
alias dpull='docker pull registry.gitlab.com/gitlab-com/customer-success/tools/congregate/master:$(get_latest_master_tag)'
alias drun='docker run \
              --name congregate \
              -v /var/run/docker.sock:/var/run/docker.sock \
              -v $HOME/congregate_data:/opt/congregate/data \
              -p 8000:8000 \
              -it registry.gitlab.com/gitlab-com/customer-success/tools/congregate/master:$(get_latest_master_tag) \
              /bin/bash'
alias pyclean='find ./congregate -name "*.pyc" -delete'
alias gendocs='./read-docs.sh'
alias kc='kill $(get_congregate_pids)'
alias kc9='kill -9 $(get_congregate_pids)'

printf '# pyproject.toml and Dockerfile aliases\n'
alias penv
alias ui
alias sh
alias upd
alias pt
alias pt_e2e
printf '\n# docker pull latest docker image on master\n'
alias dpull
printf '\n# docker run latest docker image on master\n'
alias drun
alias pyclean
alias gendocs
alias kc
alias kc9
